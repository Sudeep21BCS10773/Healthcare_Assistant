<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <title>Healthcare Assistant</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <!-- Bootstrap -->
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
  <link rel="stylesheet" href="{{ url_for('static', filename='style.css') }}">
</head>
<body class="bg-light">
  <div class="container py-4">
    <h2 class="mb-3">Healthcare Assistant</h2>

    <!-- Patient profile -->
    <div class="card mb-3">
      <div class="card-body">
        <form id="profileForm" class="row gy-2 gx-2 align-items-end">
          <div class="col-12 col-md-2">
            <label class="form-label">Name</label>
            <input class="form-control" id="name" placeholder="e.g., Sudeep">
          </div>
          <div class="col-6 col-md-1">
            <label class="form-label">Age</label>
            <input class="form-control" id="age" type="number" min="0" max="120">
          </div>
          <div class="col-6 col-md-2">
            <label class="form-label">Sex</label>
            <select class="form-select" id="sex">
              <option value="">Prefer not to say</option>
              <option>Male</option>
              <option>Female</option>
              <option>Other</option>
            </select>
          </div>
          <div class="col-6 col-md-2">
            <label class="form-label">Pregnant</label>
            <select class="form-select" id="pregnant">
              <option value="">N/A</option>
              <option>Yes</option>
              <option>No</option>
            </select>
          </div>
          <div class="col-12 col-md-2">
            <label class="form-label">Allergies</label>
            <input class="form-control" id="allergies" placeholder="e.g., penicillin">
          </div>
          <div class="col-12 col-md-3">
            <label class="form-label">Conditions</label>
            <input class="form-control" id="conditions" placeholder="e.g., asthma, diabetes">
          </div>
          <div class="col-12 col-md-12">
            <button class="btn btn-primary" type="submit">Save Profile</button>
            <span class="ms-2 small text-muted" id="profileStatus"></span>
          </div>
        </form>
      </div>
    </div>

    <div class="row g-3">
      <!-- Chat -->
      <div class="col-12 col-lg-7">
        <div class="card h-100">
          <div class="card-body d-flex flex-column">
            <div id="chatBox" class="flex-grow-1 overflow-auto border rounded p-3 bg-white">
              <div class="bot-msg">
                üëã Hi! I‚Äôm your health assistant. Share your symptoms or questions. I‚Äôll give general guidance and when to seek care.
              </div>
            </div>
            <div class="mt-3 d-flex gap-2">
              <input id="userInput" class="form-control" placeholder="Type your message... (Enter to send)">
              <button id="sendBtn" class="btn btn-success">Send</button>
            </div>
          </div>
        </div>
      </div>

      <!-- Facilities finder -->
      <div class="col-12 col-lg-5">
        <div class="card h-100">
          <div class="card-body">
            <h5 class="card-title">Find Nearby Medical Facilities</h5>
            <div class="d-flex gap-2 mb-2 flex-wrap">
              <button class="btn btn-outline-primary btn-sm fac-btn" data-type="hospital">Hospitals</button>
              <button class="btn btn-outline-primary btn-sm fac-btn" data-type="pharmacy">Pharmacies</button>
              <button class="btn btn-outline-primary btn-sm fac-btn" data-type="clinic">Clinics</button>
              <button class="btn btn-outline-primary btn-sm fac-btn" data-type="lab">Labs</button>
              <button class="btn btn-outline-danger btn-sm fac-btn" data-type="emergency">Emergency</button>
            </div>
            <div class="input-group mb-2">
              <input id="radius" type="number" class="form-control" value="5000" min="500" step="500">
              <span class="input-group-text">meters</span>
            </div>
            <div class="small text-muted mb-2">We‚Äôll request your location (browser prompt) to search nearby.</div>
            <div id="facilitiesList" class="list-group small"></div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <script>
    let SESSION_ID = null;

    function ts() {
      const d = new Date();
      return d.toLocaleString();
    }

    function appendMsg(text, who="bot") {
      const box = document.getElementById("chatBox");
      const div = document.createElement("div");
      div.className = who === "user" ? "user-msg" : "bot-msg";
      div.innerHTML = `<div class="msg-bubble">${text}</div><div class="ts">${ts()}</div>`;
      box.appendChild(div);
      box.scrollTop = box.scrollHeight;
    }

    async function initSession(profile={}) {
      const res = await fetch("/session", {
        method: "POST",
        headers: {"Content-Type": "application/json"},
        body: JSON.stringify({ session_id: SESSION_ID, ...profile })
      });
      const data = await res.json();
      SESSION_ID = data.session_id;
      return data.profile || {};
    }

    // Save profile
    document.getElementById("profileForm").addEventListener("submit", async (e)=>{
      e.preventDefault();
      const profile = {
        name: document.getElementById("name").value,
        age: document.getElementById("age").value,
        sex: document.getElementById("sex").value,
        pregnant: document.getElementById("pregnant").value,
        allergies: document.getElementById("allergies").value,
        conditions: document.getElementById("conditions").value,
      };
      const saved = await initSession(profile);
      document.getElementById("profileStatus").innerText = "Profile saved.";
      setTimeout(()=>document.getElementById("profileStatus").innerText="", 2000);
    });

    // Chat send
    async function sendMessage() {
      const input = document.getElementById("userInput");
      const text = input.value.trim();
      if (!text) return;
      appendMsg(text, "user");
      input.value = "";

      const res = await fetch("/chat", {
        method: "POST",
        headers: {"Content-Type": "application/json"},
        body: JSON.stringify({ session_id: SESSION_ID, message: text })
      });
      const data = await res.json();
      appendMsg(data.reply || "Error.");
    }

    document.getElementById("sendBtn").addEventListener("click", sendMessage);
    document.getElementById("userInput").addEventListener("keydown", (e)=>{
      if (e.key === "Enter") sendMessage();
    });

    // Facilities
    async function findFacilities(type) {
      const radius = document.getElementById("radius").value || 5000;
      const list = document.getElementById("facilitiesList");
      list.innerHTML = `<div class="list-group-item">Locating‚Ä¶</div>`;

      if (!navigator.geolocation) {
        list.innerHTML = `<div class="list-group-item text-danger">Geolocation not supported.</div>`;
        return;
      }

      navigator.geolocation.getCurrentPosition(async (pos)=>{
        const lat = pos.coords.latitude, lng = pos.coords.longitude;
        try {
          const url = `/facilities?type=${encodeURIComponent(type)}&lat=${lat}&lng=${lng}&radius=${radius}`;
          const res = await fetch(url);
          const data = await res.json();
          if (data.error) {
            list.innerHTML = `<div class="list-group-item text-danger">${data.error}</div>`;
            return;
          }
          if (!data.results || data.results.length === 0) {
            list.innerHTML = `<div class="list-group-item">No results found.</div>`;
            return;
          }
          list.innerHTML = "";
          data.results.forEach(p=>{
            const addr = p.address ? `<div class="text-muted">${p.address}</div>` : "";
            const rating = p.rating ? `‚≠ê ${p.rating} (${p.user_ratings_total || 0})` : "No rating";
            const open = p.open_now===true ? `<span class="badge bg-success ms-1">Open now</span>` :
                         p.open_now===false ? `<span class="badge bg-secondary ms-1">Closed</span>` : "";
            const maps = `https://www.google.com/maps/search/?api=1&query=${p.lat},${p.lng}&query_place_id=${p.place_id}`;
            const item = document.createElement("a");
            item.href = maps;
            item.target = "_blank";
            item.className = "list-group-item list-group-item-action";
            item.innerHTML = `<div class="fw-semibold">${p.name}</div>${addr}<div class="small">${rating} ${open}</div>`;
            list.appendChild(item);
          });
        } catch (e) {
          list.innerHTML = `<div class="list-group-item text-danger">Error: ${e}</div>`;
        }
      }, (err)=>{
        list.innerHTML = `<div class="list-group-item text-danger">Location error: ${err.message}</div>`;
      }, { enableHighAccuracy: true, timeout: 10000 });
    }

    document.querySelectorAll(".fac-btn").forEach(b=>{
      b.addEventListener("click", ()=> findFacilities(b.dataset.type));
    });

    // First session bootstrap
    initSession({});
  </script>
</body>
</html>
